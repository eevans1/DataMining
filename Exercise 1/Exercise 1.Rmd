---
title: "Exercise 1"
output: github_document
author:
- Wyatt Allen, Elijah Evans, David Ford, Patrick Scovel
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data visualization 1: green buildings

```{r}
Green.Buildings <- read.csv("C:/Users/small/OneDrive/Spring 2019/Data Mining Local/Data Sets/Green Buildings.csv")
# greenbuildings <- read.csv("~/Documents/UT Austin/2019 Spring/DataScience/Homework/Excercise 1/greenbuildings.csv")

# Libraries
install.packages("ggplot2")
library(ggplot2)
install.packages("ggplot2")
library(ggalt)
install.packages("ggplot2")
library(gifski)
install.packages("ggplot2")
library(gganimate)
install.packages("ggplot2")
library(gapminder)
library(grid)
library(gridExtra)
library(plyr)


# Ultimately what one the two positive outcomes that a developer is looking for is (a) rent and (b) leasing rate
# We simply plot our data on these two axis to get an idea of how the data set is distributed
ggplot(data = greenbuildings) +
  geom_point(mapping = aes(x = leasing_rate, y = Rent)) +
  xlab("Leasing rate (%)") +
  ylab("Rent ($/sqft)")

# Our data contains a few outliers of extremely high rent and very low leasing rate
# We have no reason to believe that our building will fall into these two categories
# We will concern outselves with the bulk of the data that has an above 50% occupancy rate and a rend below 100 $/sqft
# This restriction will still leave the vast majority of the data
gb_cut = subset(greenbuildings, Rent <=100 & leasing_rate >=50)
# Represented below is the new distribution 
ggplot(data = gb_cut) +
  geom_point(mapping = aes(x = leasing_rate, y = Rent)) +
  xlab("Leasing rate (%)") +
  ylab("Rent ($/sqft)")


# Our builder is concerned with the decision of "going green" 
# To illustrate this in our data we colour the apartments that have green certifications
# Color code
ggplot(data = gb_cut) +
  geom_point(aes(x = leasing_rate, y = Rent, colour = factor(green_rating)))+
  xlab("Leasing rate (%)") +
  ylab("Rent ($/sqft)") +
  scale_colour_manual( name = "Green Certification",
                       labels = c("No", "Yes"),
                       values = c("0" = "#5a5a5a", "1" = "#4daf4d"))

# We note here that the buildings with green certifications appear to have slightly higher leasing rates
# Furthermore, there appears to be a larger clump of low-rent buildings without green certificaions 
med_val_lr <- ddply(gb_cut, .(green_rating), summarise, med = median(leasing_rate))
colnames(med_val_lr) <- c("green_rating", "leasing_rate")
g1 <- ggplot(data = gb_cut, aes(x = factor(green_rating), y = leasing_rate)) + 
  geom_boxplot(aes(colour = factor(green_rating))) + ylab("Leasing rate (%)") +
  scale_colour_manual(name = "",
                    guide = FALSE,
                    values = c("0" = "#5a5a5a","1" = "#4daf4d")) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  geom_text(data = med_val_lr, aes(x = factor(green_rating), y = leasing_rate, label = leasing_rate), 
            size = 3, vjust = -1)
med_val_r <- ddply(gb_cut, .(green_rating), summarise, med = median(Rent))
colnames(med_val_r) <- c("green_rating", "Rent")
g2 <- ggplot(data = gb_cut, aes(x = factor(green_rating), y = Rent)) + 
  geom_boxplot(aes(colour = factor(green_rating))) + ylab("Rent ($/sqft)") +
  scale_colour_manual(name = "",
                      guide = FALSE,
                      values = c("0" = "#5a5a5a","1" = "#4daf4d")) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  geom_text(data = med_val_r, aes(x = factor(green_rating), y = Rent, label = Rent), 
            size = 3, vjust = -1)
grid.arrange(g1,g2,nrow=2, padding = unit(0, "line"))

# We can see that both the leasing rate and the rent are higher for green buildings

# An interesting theory might be that green buildings typically correspond to newer developments 
# And newer developments might correspond to nicer buildings and therefore higher rents and leasing rates


#  Here we define an arbitrary cuttoff between "old" and "new" buildings
age_cutoff = 20
greenbuildings$new = ifelse(greenbuildings$age <= age_cutoff, 1, 0)
# We will also now categorize whether the building is new and whether its is green into four groups

# Define categories
cat_nongreen_nonnew = greenbuildings$green_rating == 0 & greenbuildings$new == 0
cat_nongreen_new = greenbuildings$green_rating == 0 & greenbuildings$new == 1
cat_green_nonnew = greenbuildings$green_rating == 1 & greenbuildings$new == 0
cat_green_new = greenbuildings$green_rating == 1 & greenbuildings$new == 1

# Create categorical variable denoting the category
greenbuildings$cat = ifelse(cat_nongreen_nonnew, "ngnn", 
                            ifelse(cat_nongreen_new, "ngn", 
                                   ifelse(cat_green_nonnew, "gnn", 
                                          ifelse(cat_green_new, "gn", 0))))
gb_cut = subset(greenbuildings, Rent <=100 & leasing_rate >=50)


# This new plot now considers whether a building is relatively new
# If the point is filled in then it represents a newer development
g_shaped <- ggplot(data = gb_cut) +
  geom_point(aes(x = leasing_rate, 
                 y = Rent, 
                 colour = factor(green_rating),
                 shape = factor(new))) +
  scale_shape_manual( name = "",
                      labels = c("Older", "Newer"),
                      values = c("0" = 1,"1" = 19)) +
  scale_colour_manual( name = "",
                     labels = c("Non-Green", "Green"),
                     values = c("0" = "#5a5a5a", "1" = "#4daf4d")) + 
  xlab("Leasing rate (%)") +
  ylab("Rent ($/sqft)")
# It is difficult to make out everything so we will cycle through the different states
ani_cat <- animate(g_shaped + transition_manual(cat), renderer = gifski_renderer(), width = 1500, height = 1000, res = 100)
ani_cat

# Here it looks like by simply controlling for newer developments,
# we have removed many of the low occupancy buildings from the non-green apartments

# We can now look at the box and whiskers just for the new buildings and the gap has considerably shrunk
med_val_lr <- ddply(subset(gb_cut, new == 1), .(green_rating), summarise, med = median(leasing_rate))
colnames(med_val_lr) <- c("green_rating", "leasing_rate")
g1 <- ggplot(data = subset(gb_cut, new == 1), aes(x = factor(green_rating), y = leasing_rate)) + 
  geom_boxplot(aes(colour = factor(green_rating))) + ylab("Leasing rate (%)") +
  scale_colour_manual(name = "",
                      guide = FALSE,
                      values = c("0" = "#5a5a5a","1" = "#4daf4d")) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  geom_text(data = med_val_lr, aes(x = factor(green_rating), y = leasing_rate, label = leasing_rate), 
            size = 3, vjust = -1)
med_val_r <- ddply(subset(gb_cut, new == 1), .(green_rating), summarise, med = median(Rent))
colnames(med_val_r) <- c("green_rating", "Rent")
g2 <- ggplot(data = subset(gb_cut, new == 1), aes(x = factor(green_rating), y = Rent)) + 
  geom_boxplot(aes(colour = factor(green_rating))) + ylab("Rent ($/sqft)") +
  scale_colour_manual(name = "",
                      guide = FALSE,
                      values = c("0" = "#5a5a5a","1" = "#4daf4d")) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  geom_text(data = med_val_r, aes(x = factor(green_rating), y = Rent, label = Rent), 
            size = 3, vjust = -1)
grid.arrange(g1,g2,nrow=2, padding = unit(0, "line"))

# To finalize this study we can control for a few more variables that the situation discribes
# The developer describes the building that is 
# - 15 stories
# - Mixed use
# - Is located on East Cesar Chavez
##  - One can find online sources for the approximate rent of an East Cesar Chavez apartment.
##    Esitmates are approximately $27/sqft      
# - Is a new construction

# With these qualifications we can find apartments in our data set that could be considered roughly comprable  
comp_loose <- 
  greenbuildings$Rent>=20 & greenbuildings$Rent<=35 & 
  greenbuildings$stories>=5 & greenbuildings$stories <= 25 & 
  greenbuildings$age<15 & greenbuildings$amenities==1

# We now indicate those buildings that fall under this qualification
greenbuildings$comps <- ifelse(comp_loose, "loose", ".")

# Idealy we would like to see where this range of building factors are located on our data set

# Here we will construct a polygon sized to the interquartile of the leasing rent and Rent
# First a rudimentary data structure to store our values
# 1st dim: non green, green
# 2nd dim: 25th quartile, 75 quartile
# 3rd dim: leasing rate, rent
matrix <- array(0, dim=c(2, 2, 2))
# Create a new data frame representing our comps
comps_df = subset(greenbuildings, comps == "loose")
# This now se separate into green and non green
gdf <- subset(comps_df, green_rating ==1)
ngdf <- subset(comps_df, green_rating ==0)

### Non Green 
## Leasing Rate
# 25th Quantile
matrix[1,1,1] <- quantile(ngdf$leasing_rate, .25)
# 75th Quantile
matrix[1,2,1] <- quantile(ngdf$leasing_rate, .75)

## Rent
# 25th Quantile
matrix[1,1,2] <- quantile(ngdf$Rent, .25)
# 75th Quantile
matrix[1,2,2] <- quantile(ngdf$Rent, .75)

### Green 
## Leasting Rate
# 25th Quantile
matrix[2,1,1] <- quantile(gdf$leasing_rate, .25)
# 75th Quantile
matrix[2,2,1] <- quantile(gdf$leasing_rate, .75)

## Rent
# 25th Quantile
matrix[2,1,2] <- quantile(gdf$Rent, .25)
# 75th Quantile
matrix[2,2,2] <- quantile(gdf$Rent, .75)

# Here we create our polygon vertices
ids <- factor(c(0,1))

values <- data.frame(
  id = ids,
  value = c(0, 1)
)


positions <- data.frame(
  id = rep(ids, each = 4),
  x = c(matrix[1,1,1], matrix[1,2,1], matrix[1,2,1], matrix[1,1,1], matrix[2,1,1], matrix[2,2,1], matrix[2,2,1], matrix[2,1,1]),
  y = c(matrix[1,1,2], matrix[1,1,2], matrix[1,2,2], matrix[1,2,2], matrix[2,1,2], matrix[2,1,2], matrix[2,2,2], matrix[2,2,2])
)

datapoly <- merge(values, positions, by = c("id"))

# Now we overlay our quantile polygon on our previous data
ggplot(data = gb_cut) +
  geom_point(aes(x = leasing_rate, 
                 y = Rent, 
                 colour = factor(green_rating),
                 shape = factor(new))) +
  scale_shape_manual( name = "",
                      labels = c("Older", "Newer"),
                      values = c("0" = 1,"1" = 19)) +
  scale_colour_manual( name = "",
                       labels = c("Non-Green", "Green"),
                       values = c("0" = "#5a5a5a", "1" = "#4daf4d")) + 
  xlab("Leasing rate (%)") +
  ylab("Rent ($/sqft)") +
  geom_polygon(data = datapoly, aes(x=x, y=y, fill = factor(value), group = id), alpha = 0.6) +
  scale_fill_manual( name = "",
                      labels = c("Non-Green", "Green"),
                      values = c("0" = 1,"1" = 19))

# Here we see that the interquartile range for the green within the iqr of the non-green
# For our comps the decision to go green is less clear than before
# It appears that from our data not upgrading would be an acceptable option
# The green buildings tend to have very slight higher median leasing rates and slightly higher median rents; 
# however, it is far from conclusive. 
# It is important to note that the 75th quantile of the non-green does extend higher in both dimensions than the green
# It may be more worth while for the developer to spend money that could have gone into green appliances
# And instead invest in more luxirous dwellings that prompt higher rents and leasing rates
# More data is needed to more accurately represent the dwelling that
# the developer wants to build.

# Data is now shown in a box plot
med_val_lr <- ddply(comps_df, .(green_rating), summarise, med = median(leasing_rate))
colnames(med_val_lr) <- c("green_rating", "leasing_rate")
g1 <- ggplot(data = comps_df, aes(x = factor(green_rating), y = leasing_rate)) + 
  geom_boxplot(aes(colour = factor(green_rating))) + ylab("Leasing rate (%)") +
  scale_colour_manual(name = "",
                      guide = FALSE,
                      values = c("0" = "#5a5a5a","1" = "#4daf4d")) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  geom_text(data = med_val_lr, aes(x = factor(green_rating), y = leasing_rate, label = leasing_rate), 
            size = 3, vjust = 1.2)
med_val_r <- ddply(comps_df, .(green_rating), summarise, med = median(Rent))
colnames(med_val_r) <- c("green_rating", "Rent")
g2 <- ggplot(data = comps_df, aes(x = factor(green_rating), y = Rent)) + 
  geom_boxplot(aes(colour = factor(green_rating))) + ylab("Rent ($/sqft)") +
  scale_colour_manual(name = "",
                      guide = FALSE,
                      values = c("0" = "#5a5a5a","1" = "#4daf4d")) + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  geom_text(data = med_val_r, aes(x = factor(green_rating), y = Rent, label = Rent), 
            size = 3, vjust = -1)
grid.arrange(g1,g2,nrow=2, padding = unit(0, "line"))
```

## Data visualization 2: flights at ABIA

```{r, echo=FALSE, results='hide'}
ABIA <- read.csv("C:/Users/small/OneDrive/Spring 2019/Data Mining Local/Data Sets/ABIA.csv")
library(ggplot2)
library(tidyverse)

#Creating a Subset
ABIA$TotalDelay <- ABIA$DepDelay + ABIA$ArrDelay # defining an important variable
DenFlights <- subset(ABIA, ABIA$Dest=="DEN") # subsetting the data, only care about DEN

#Plotting by Mean
AvgCarrierDelay <- aggregate(DenFlights$TotalDelay ~ DenFlights$UniqueCarrier, data=DenFlights, mean) # finding mean by carrier
AvgCarrierDelay # seeing what it looks like
colnames(AvgCarrierDelay) <- c("Carrier", "Avg Delay") # renaming the columns
AvgCarrierDelay <- AvgCarrierDelay[order(AvgCarrierDelay$`Avg Delay`), ]  # sort
AvgCarrierDelay$Carrier <- factor(AvgCarrierDelay$Carrier, levels = AvgCarrierDelay$Carrier)  # to retain the order in plot
head(AvgCarrierDelay, 5) # taking a goose gander
library(ggplot2) #loading ggplot2
ggplot(data=AvgCarrierDelay, aes(x=AvgCarrierDelay$Carrier, y=AvgCarrierDelay$`Avg Delay`))+
  geom_bar(stat="identity", width=.5, fill="tomato3") + 
  labs(title="Average Delays to Denver", 
       x="Carrier",
       y="AvgDelay (minutes)",
       subtitle="Airline Carrier vs Average Minutes Delayed", 
       caption="source: ABIA") + 
  theme(axis.text.x = element_text(angle=0, vjust=0.6))             

#Plotting by Median
AvgCarrierDelayMedian <- aggregate(DenFlights$TotalDelay ~ DenFlights$UniqueCarrier, data=DenFlights, median) # finding median by carrier
AvgCarrierDelayMedian # seeing what it looks like
colnames(AvgCarrierDelayMedian) <- c("Carrier", "Avg Delay") # renaming the columns
AvgCarrierDelayMedian <- AvgCarrierDelayMedian[order(c("F9", "WN", "UA", "YV", "OO")), ]  # sort
AvgCarrierDelayMedian$Carrier <- factor(AvgCarrierDelayMedian$Carrier, levels = c("F9", "WN", "UA", "YV", "OO"))  # to retain the order in plot
head(AvgCarrierDelayMedian, 5) # taking a goose gander
ggplot(data=AvgCarrierDelayMedian, aes(x=AvgCarrierDelayMedian$Carrier, y=AvgCarrierDelayMedian$`Avg Delay`))+
  geom_bar(stat="identity", width=.5, fill="tomato3") + 
  labs(title="Median Delay to Denver", 
       x="Carrier",
       y="Median Delay (minutes)",
       subtitle="Airline Carrier vs Median Delay", 
       caption="source: ABIA") + 
  theme(axis.text.x = element_text(angle=0, vjust=0.6))
```

Using the attached code, we have derived the average delay for the five airliners that fly to Denver, CO from ABIA, as well as the median delays. The first graph is in increasing order of average delay times, but for the second one we made the decision to maintain the original ordering to promote easier comparisons. The most notable thing discovered by comparing these graphs is that no airliner has a negative mean delay, but four of the five airliners have negative median delays. We attribute this difference to outliers skewing the average. There are a few flights for each airliner that have hugely negative delays, even over 10 hours in a few cases. However, the negative delays, indicating an earlier arrival than anticipated, are never more than around 30 minutes. This made intuitive sense to us, as it is possible to leave an airport an indefinite amount of time after a scheduled departure, but an airplane can't really leave hours before it's scheduled to land, as it would clearly be unjust to expect all of the passengers and crew to be boarded and ready an hour or ten early, meaning that there is somewhat of a ceiling on how early a flight can be, but little to no limit on how late it can be. 

## Regression vs KNN

Placeholder 2